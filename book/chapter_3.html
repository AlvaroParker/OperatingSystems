<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Mechanism - Limited Direct Execution - Operating Systems: Book Summary</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="chapter_1.html"><strong aria-hidden="true">1.</strong> The Process</a></li><li class="chapter-item expanded "><a href="chapter_2.html"><strong aria-hidden="true">2.</strong> Process API</a></li><li class="chapter-item expanded "><a href="chapter_3.html" class="active"><strong aria-hidden="true">3.</strong> Mechanism - Limited Direct Execution</a></li><li class="chapter-item expanded "><a href="chapter_4.html"><strong aria-hidden="true">4.</strong> Scheduling</a></li><li class="chapter-item expanded "><a href="chapter_5.html"><strong aria-hidden="true">5.</strong> Multi-Level Feedback Queue</a></li><li class="chapter-item expanded "><a href="chapter_6.html"><strong aria-hidden="true">6.</strong> Proportional Share</a></li><li class="chapter-item expanded "><a href="chapter_7.html"><strong aria-hidden="true">7.</strong> Address Spaces</a></li><li class="chapter-item expanded "><a href="chapter_8.html"><strong aria-hidden="true">8.</strong> Mechanism - Address Translation</a></li><li class="chapter-item expanded "><a href="chapter_9.html"><strong aria-hidden="true">9.</strong> Segmentation</a></li><li class="chapter-item expanded "><a href="chapter_10.html"><strong aria-hidden="true">10.</strong> Free-Space Management</a></li><li class="chapter-item expanded "><a href="chapter_11.html"><strong aria-hidden="true">11.</strong> Paging - Introduction</a></li><li class="chapter-item expanded "><a href="chapter_12.html"><strong aria-hidden="true">12.</strong> Paging - Faster Translation</a></li><li class="chapter-item expanded "><a href="chapter_13.html"><strong aria-hidden="true">13.</strong> Paging - Smaller Tables</a></li><li class="chapter-item expanded "><a href="chapter_14.html"><strong aria-hidden="true">14.</strong> Beyond Physical Memory - Mechanism</a></li><li class="chapter-item expanded "><a href="chapter_15.html"><strong aria-hidden="true">15.</strong> Physical Memory - Policies</a></li><li class="chapter-item expanded "><a href="chapter_17.html"><strong aria-hidden="true">16.</strong> Concurrency - An Introduction</a></li><li class="chapter-item expanded "><a href="chapter_18.html"><strong aria-hidden="true">17.</strong> Thread API</a></li><li class="chapter-item expanded "><a href="chapter_19.html"><strong aria-hidden="true">18.</strong> Locks</a></li><li class="chapter-item expanded "><a href="chapter_20.html"><strong aria-hidden="true">19.</strong> Lock-Based Concurrent Data Structures</a></li><li class="chapter-item expanded "><a href="chapter_21.html"><strong aria-hidden="true">20.</strong> Condition Variables</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Operating Systems: Book Summary</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="3-mechanism---limited-direct-execution"><a class="header" href="#3-mechanism---limited-direct-execution">3. Mechanism - Limited Direct Execution</a></h1>
<p><em>CPU virtualization: Run one process for a little while, then another one, and so forth. By time sharing the CPU, virtualization is achieved.</em></p>
<ul>
<li>Challenges in building this virtualization: 
<ol>
<li>Performance: How to implement without adding excessive overhead to the system?</li>
<li>Control: How to run processes efficiently while retaining control over the CPU?</li>
</ol>
</li>
</ul>
<h2 id="crux-how-to-efficiently-virtualize-the-cpu-with-control"><a class="header" href="#crux-how-to-efficiently-virtualize-the-cpu-with-control">Crux: How to efficiently virtualize the CPU with control?</a></h2>
<h2 id="basic-technique-limited-direct-execution"><a class="header" href="#basic-technique-limited-direct-execution">Basic technique: Limited direct execution</a></h2>
<ul>
<li>&quot;Direct Execution&quot; part: Run the program directly on the CPU
<ul>
<li>OS wishes to start a program running: 
<ol>
<li>OS creates a process entry for it in a process list.</li>
<li>Allocate some memory for it.</li>
<li>Loads the program code into memory (from disk)</li>
<li>Locates its entry point, jumps to it and starts running the users' code</li>
</ol>
<ul>
<li>Problems:
<ol>
<li>How can the OS make sure the program doesn't do anything that we don't want it to do, while still running efficiently.</li>
<li>How to do the context switch (stop the program and switch to another process) to time share the CPU thus virtualizing it. </li>
</ol>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="problem-1-restricted-operations"><a class="header" href="#problem-1-restricted-operations">Problem #1: Restricted operations</a></h2>
<p><strong>Crux: A process must be able to perform I/O and some other restricted operations, but without giving the process complete control over the system. How can the OS and hardware work together to do so?</strong></p>
<ul>
<li>Approach: Introduce a new processor mode: <em>user mode</em> 
<ul>
<li>Code that runs in user mode is restricted in what it can do (i.e it can't issue I/O requests)</li>
<li>Contrast to <em>user mode</em>: <em>kernel mode</em> - Code that runs in <em>kernel mode</em> can do what it likes.</li>
</ul>
</li>
</ul>
<p>How can we perform some kind of privileged operation (such as reading from disk) if we are on user mode?</p>
<ul>
<li>We provide the user the ability to do <strong>system calls</strong>. </li>
</ul>
<h3 id="system-calls"><a class="header" href="#system-calls">System calls</a></h3>
<p>They allow the kernel to carefully expose certain key pieces of functionality to user programs, such as:</p>
<ul>
<li>Accessing the file system</li>
<li>Creating and destroying processes</li>
<li>Communicating with other processes </li>
<li>Allocating more memory
Most OS provide a few hundred calls.</li>
</ul>
<h4 id="how-to-do-a-system-call"><a class="header" href="#how-to-do-a-system-call">How to do a system call?</a></h4>
<ul>
<li>Program executes a special <strong>trap</strong> instruction. </li>
<li>Trap instruction jumps into the kernel and raises the privilege to kernel  mode</li>
<li>Once in kernel mode, the system can now perform whatever privileged operation that's needed (if allowed), hence doing the required work  for the calling process. </li>
<li>When it operation it's finished, OS calls a special <strong>return-from-trap</strong> instruction that returning into the calling user program while reducing the privilege level back to user mode. </li>
</ul>
<h4 id="how-does-the-trap-knows-which-code-to-run-inside-the-os"><a class="header" href="#how-does-the-trap-knows-which-code-to-run-inside-the-os">How does the trap knows which code to run inside the OS?</a></h4>
<ul>
<li>Clearly the calling process can't specify an address to jump to (bad idea since you will be jumping to anywhere into the kernel)</li>
<li>Kernel controls what code executes upon a trap by setting up a trap table at boot time.</li>
<li>The OS tells the hardware what code to run when a certain exception event occurs. </li>
<li>To specify an exact system call, a system-call number is usually assigned to each system call. </li>
<li>The user code, is responsible for placing the desired system-call number in a register or location on the stack. </li>
<li>The OS, when handling the system call inside the trap handle, examines the number, ensures it's valid and executes the corresponding code if it is.</li>
</ul>
<h3 id="example"><a class="header" href="#example">Example:</a></h3>
<p>Process want to read a file. </p>
<ul>
<li>Program calls the <code>read</code> function with the proper function arguments. </li>
<li><code>read</code> loads the system call number <code>5</code> (for xv6-riscv) into the <code>a7</code> register</li>
<li><code>read</code> execute the <code>ecall</code> instruction to trigger the exception (trap)</li>
<li>Now on kernel mode, it sees that an exception/trap has occurred</li>
<li>The kernel saves the user registers on to a special place on memory/cpu</li>
<li>The kernel reads the <code>a7</code> register, saves the number and calls the system call with the corresponding number</li>
<li>When the system call finishes, it places the resulting return value into register <code>a0</code> of the user program</li>
<li>Kernel calls <code>usertrapret</code> function which returns to user space and restores the cpu registers</li>
<li>Now back to user space, the user program continues the execution with the result of the system call. </li>
</ul>
<h2 id="problem-2-switching-between-processes"><a class="header" href="#problem-2-switching-between-processes">Problem #2: Switching between processes</a></h2>
<p><strong>Crux: How can the operating system regain control of the CPU so that it can switch between processes?</strong></p>
<h3 id="cooperative-approach"><a class="header" href="#cooperative-approach">Cooperative approach</a></h3>
<p>The OS <em>trusts</em> the processes of the system to behave reasonably. Processes that run for too long are assumed to periodically give up the CPU so that the OS can decide to run some other task. </p>
<ul>
<li>Most processes transfer control of the CPU to the OS by making system calls.</li>
<li>Processes transfer control to the OS when they do something illegal (dividing by zero, trying to access memory that it shouldn't, etc)
Problems: </li>
<li>Process ends up on an infinite loop, the OS never regains control</li>
<li>Malicious process intentionally never gives up the CPU</li>
</ul>
<h3 id="non-cooperative-approach-the-os-take-control"><a class="header" href="#non-cooperative-approach-the-os-take-control">Non-Cooperative Approach: The OS Take Control</a></h3>
<ul>
<li>The OS uses a timer interrupt; A device that's programmed to raise an interrupt every so many milliseconds; when the interrupt is raised, the currently running process is halted and a pre-configured interrupt handle in the OS runs. </li>
<li>OS regained control of the CPU and it can do what it pleases</li>
<li>On boot time the OS tells the hardware which code to run when a timer interrupts happens. </li>
<li>On boot time the OS must start the timer</li>
</ul>
<h3 id="saving-and-restoring--context"><a class="header" href="#saving-and-restoring--context">Saving and restoring  context</a></h3>
<p>The OS has regained control and now has a decision to make: </p>
<ul>
<li>To continue running the currently-running process </li>
<li>To switch to a different process</li>
</ul>
<h4 id="switch-to-a-different-process"><a class="header" href="#switch-to-a-different-process">Switch to a different process</a></h4>
<p>If the decision if to switch to a different process, the kernel executes a low level piece of code known as a context switch: </p>
<ul>
<li>The OS will execute some low-level assembly to save :
<ul>
<li>General purpose registers </li>
<li>PC (program counter)</li>
<li>Kernel stack pointer of the currently running process</li>
</ul>
</li>
<li>The OS will restore
<ul>
<li>General purpose registers</li>
<li>PC (program counter)</li>
<li>Switch to kernel stack of soon to be run process
By switching stacks, the kernel does the context switch. </li>
</ul>
</li>
</ul>
<p>When the OS finally execute a return-from-trap instruction, the soon-to-be-executing process become the currently running process, and thus the context switch is complete. </p>
<center><img src="./images/ContextSwitch.png"></center>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="chapter_2.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="chapter_4.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="chapter_2.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="chapter_4.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <!-- Livereload script (if served using the cli tool) -->
        <script>
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsAddress = wsProtocol + "//" + location.host + "/" + "__livereload";
            const socket = new WebSocket(wsAddress);
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
