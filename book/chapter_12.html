<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Paging - Faster Translation - Operating Systems: Book Summary</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="chapter_1.html"><strong aria-hidden="true">1.</strong> The Process</a></li><li class="chapter-item expanded "><a href="chapter_2.html"><strong aria-hidden="true">2.</strong> Process API</a></li><li class="chapter-item expanded "><a href="chapter_3.html"><strong aria-hidden="true">3.</strong> Mechanism - Limited Direct Execution</a></li><li class="chapter-item expanded "><a href="chapter_4.html"><strong aria-hidden="true">4.</strong> Scheduling</a></li><li class="chapter-item expanded "><a href="chapter_5.html"><strong aria-hidden="true">5.</strong> Multi-Level Feedback Queue</a></li><li class="chapter-item expanded "><a href="chapter_6.html"><strong aria-hidden="true">6.</strong> Proportional Share</a></li><li class="chapter-item expanded "><a href="chapter_7.html"><strong aria-hidden="true">7.</strong> Address Spaces</a></li><li class="chapter-item expanded "><a href="chapter_8.html"><strong aria-hidden="true">8.</strong> Mechanism - Address Translation</a></li><li class="chapter-item expanded "><a href="chapter_9.html"><strong aria-hidden="true">9.</strong> Segmentation</a></li><li class="chapter-item expanded "><a href="chapter_10.html"><strong aria-hidden="true">10.</strong> Free-Space Management</a></li><li class="chapter-item expanded "><a href="chapter_11.html"><strong aria-hidden="true">11.</strong> Paging - Introduction</a></li><li class="chapter-item expanded "><a href="chapter_12.html" class="active"><strong aria-hidden="true">12.</strong> Paging - Faster Translation</a></li><li class="chapter-item expanded "><a href="chapter_13.html"><strong aria-hidden="true">13.</strong> Paging - Smaller Tables</a></li><li class="chapter-item expanded "><a href="chapter_14.html"><strong aria-hidden="true">14.</strong> Beyond Physical Memory - Mechanism</a></li><li class="chapter-item expanded "><a href="chapter_15.html"><strong aria-hidden="true">15.</strong> Physical Memory - Policies</a></li><li class="chapter-item expanded "><a href="chapter_17.html"><strong aria-hidden="true">16.</strong> Concurrency - An Introduction</a></li><li class="chapter-item expanded "><a href="chapter_18.html"><strong aria-hidden="true">17.</strong> Thread API</a></li><li class="chapter-item expanded "><a href="chapter_19.html"><strong aria-hidden="true">18.</strong> Locks</a></li><li class="chapter-item expanded "><a href="chapter_20.html"><strong aria-hidden="true">19.</strong> Lock-Based Concurrent Data Structures</a></li><li class="chapter-item expanded "><a href="chapter_21.html"><strong aria-hidden="true">20.</strong> Condition Variables</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Operating Systems: Book Summary</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="12-paging---faster-translations"><a class="header" href="#12-paging---faster-translations">12. Paging - Faster Translations</a></h1>
<p>On the previous chapter we saw that: </p>
<ul>
<li>By  using paging, we require a large amount of mapping information</li>
<li>The mapping information is usually stored in physical memory</li>
<li>Paging, hence requires an extra memory lookup for each virtual address generated by the running program (we need to check the mapped information that's stored in memory )</li>
</ul>
<h2 id="the-solution-tlb"><a class="header" href="#the-solution-tlb">The solution: TLB</a></h2>
<ul>
<li>To speed address translation we need help from the hardware</li>
<li>We add what's called a <strong>translation-lookaside buffer</strong> (TLB) </li>
<li>TLB is part of the chips memory-management unit (MMU) </li>
<li>It's a hardware cache, but because is &quot;closer&quot; to the CPU, memory access is much faster</li>
</ul>
<p><strong>What does it do?</strong> </p>
<ul>
<li>For each virtual memory reference, we check the TLB to see if the translation is there</li>
<li>If it is, we perform the translation, without having to access physical memory</li>
</ul>
<h2 id="tlb-basic-algorithm"><a class="header" href="#tlb-basic-algorithm">TLB Basic algorithm</a></h2>
<pre><code>VPN = (VirtualAddress &amp; VPN_MASK) &gt;&gt; SHIFT 
(Success, TlbEntry) = TLB_Lookup(VPN)
if (Success == True) // TLB Hit
	if (CanAccess(TlbEntry.ProtectBits) == True)
		Offset = VirtualAddress &amp; OFFSET_MASK
		PhysAddr = (TlbEntry.PFN &lt;&lt; SHIFT) | Offset
		Register = AccessMemory(PhysAddr)
	else
		RaiseException(PROTECTION_FAULT)
else // TLB Miss
	PTEAddr = PTBR + (VPN * sizeof(PTE))
	PTE = AccessMemory(PTEAddr) // Bad performance, we are accessing memory :(
	if (PTE.Valid == False)
		RaiseException(SEGMENTATION_FAULT)
	else if (CanAccess(PTE.ProtectedBits) == False)
		RaiseException(SEGMENTATION_FAULT)
	else
		TLB_Insert(VPN, PTE.PFN, PTE.ProtectedBits)
		RetryInstruction()	
</code></pre>
<p>This algorithms works like this: </p>
<ol>
<li>Extract the virtual page number (VPN) from the virtual address </li>
<li>Check if the TLB holds the translation for this VPN</li>
<li>If it does, then the TLB holds the translation, hence we can now:
<ol>
<li>Extract the page frame number (PFN) from the TLB</li>
<li>Concatenate the PFN onto the offset from the original virtual address, hence forming the desired physical address </li>
<li>Access memory, handle errors</li>
</ol>
</li>
<li>If it doesn't find the translation in the TLB:
<ol>
<li>Hardware accesses the page table to find the translation (this is costly)</li>
<li>Assuming that the translation is valid, we update the TLB</li>
<li>Once the TLB is updated, we hardware retries the instruction </li>
</ol>
</li>
</ol>
<h2 id="tlb-miss-handling"><a class="header" href="#tlb-miss-handling">TLB Miss handling</a></h2>
<p>There are two ways to handle a TLB miss: Hardware and software wise.</p>
<h3 id="hardware-handling"><a class="header" href="#hardware-handling">Hardware handling:</a></h3>
<p>To handle TLB miss, the hardware must know: </p>
<ul>
<li>Exactly where the page tables are located in memory</li>
<li>The exact format of the page tables
On miss, the hardware walks to the page table, find the correct page-table entry and extract the desired translation, updates the TLB with the translation and retry the instruction. </li>
</ul>
<h3 id="software-handling"><a class="header" href="#software-handling">Software handling</a></h3>
<p><strong>The basic process works like this</strong> </p>
<ul>
<li>On a miss, the hardware raises an exception</li>
<li>The exception pauses the current instruction stream, raises the privilege level to kernel mode, jumps to to a trap handler</li>
<li>The trap handler, is code within the OS that is written to handle the TLB misses</li>
<li>When the trap handler runs, it will lookup the translation in the page table, updates the TLB and return from the trap</li>
<li>The hardware retries the instruction </li>
</ul>
<p>Difference between the trap signal of the TLB miss and others we saw:</p>
<ul>
<li>The return from trap is different than the one we saw on system calls. On the case of system calls, we would simply resume execution after the trap into the OS, just like a return from a procedure call.</li>
<li>In the case of the TLB trap signal, we need to resumen execution on the instruction that caused the exception (basically running the instruction again), this can cause an infinite loop, so the OS needs to be careful when raising this exception. </li>
</ul>
<h2 id="tlb-contents"><a class="header" href="#tlb-contents">TLB Contents</a></h2>
<p>A TLB entry might look like this: </p>
<pre><code>VPN | PFN | other bits
</code></pre>
<ul>
<li>Both VPN and PFN are present in each entry.</li>
<li>A translation coudl end up in any of these locations (this is called a fully-associative cache)</li>
<li>The hardware searches the entries in parallel to see if there is a match</li>
</ul>
<p>The <code>other bits</code> might contain: </p>
<ul>
<li>A <strong>valid</strong> bit: If the entry has a valid translation or not</li>
<li><strong>Protection</strong> bit: Determines how a page can be accessed (for example, code page might be marked <em>read and execute</em> only, heap might be marked <em>read and write</em>, etc.)</li>
<li><strong>Address-space</strong>, <strong>identifier</strong>, <strong>dirty bit</strong> are also common bits present in here</li>
</ul>
<h2 id="tlb-issue-context-switches"><a class="header" href="#tlb-issue-context-switches">TLB Issue: Context switches</a></h2>
<p>When switching from one process to another, the hardware or OS must be careful to ensure that the about-to-be-run process does not accidentally use translations from some previously run process. </p>
<p><strong>Example:</strong> We have a running process (P1) that assumes that the TLB is caching translations that are valid for it, i.e, that come from P1's page table, let's assume that the 10th virtual page of P1 maps to hysical frame 100. Then a context switch happens to another process (P2), assume we also have a virtual page number for this process (P2) but instead it maps to physical frame 170, if entries of both process were in the TLB, the contents of the TLB would be something like this: </p>
<div class="table-wrapper"><table><thead><tr><th>VPN</th><th>PFN</th><th>valid</th><th>prot</th></tr></thead><tbody>
<tr><td>10</td><td>100</td><td>1</td><td>rwx</td></tr>
<tr><td>10</td><td>170</td><td>1</td><td>rwx</td></tr>
</tbody></table>
</div>
<p>Here we have a problem, two VPNs with the same value map to a different PFN, each VPN is valid only to their process but we don't have a way to tell from which process is each VPN</p>
<h3 id="possible-solutions"><a class="header" href="#possible-solutions">Possible solutions</a></h3>
<h4 id="flush-the-tlb-on-context-switch"><a class="header" href="#flush-the-tlb-on-context-switch">Flush the TLB on context switch</a></h4>
<ul>
<li>On software-based system: with an explicit hardware instruction</li>
<li>On hardware-managed TLB: The flush could be enacted when the page-table base register is changed</li>
<li>On either case, the flush operations sets all valid bits to 0, clearing the contents of the TLB</li>
<li><strong>Cost:</strong> Each time a process run, it must incur TLB misses as it touches its data and code pages, the more context switches are, the higher the cost. </li>
</ul>
<h4 id="address-space-identifier"><a class="header" href="#address-space-identifier">Address space identifier</a></h4>
<ul>
<li>Hardware support to enable sharing of the TLB is added via address space identifier (ASID)</li>
<li>The ASID if kinda like a process identifier, but it has fewer bits</li>
<li>If we take our example above, we would have the following table</li>
</ul>
<div class="table-wrapper"><table><thead><tr><th>VPN</th><th>PFN</th><th>valid</th><th>prot</th><th>ASID</th></tr></thead><tbody>
<tr><td>10</td><td>100</td><td>1</td><td>rwx</td><td>1</td></tr>
<tr><td>10</td><td>170</td><td>1</td><td>rwx</td><td>2</td></tr>
</tbody></table>
</div>
<ul>
<li>Here we can identify which VPN corresponds to which process using the ASID value. </li>
</ul>
<h2 id="tlb-issue-replacement-policy"><a class="header" href="#tlb-issue-replacement-policy">TLB Issue: Replacement policy</a></h2>
<p>When we are adding an entry, we have to replace it with an old one, which one to replace? 
Typical policies are: </p>
<ul>
<li>Least-recently-used (LRU)</li>
<li>Random policy</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="chapter_11.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="chapter_13.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="chapter_11.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="chapter_13.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
