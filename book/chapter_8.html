<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Mechanism - Address Translation - Operating Systems: Book Summary</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="chapter_1.html"><strong aria-hidden="true">1.</strong> The Process</a></li><li class="chapter-item expanded "><a href="chapter_2.html"><strong aria-hidden="true">2.</strong> Process API</a></li><li class="chapter-item expanded "><a href="chapter_3.html"><strong aria-hidden="true">3.</strong> Mechanism - Limited Direct Execution</a></li><li class="chapter-item expanded "><a href="chapter_4.html"><strong aria-hidden="true">4.</strong> Scheduling</a></li><li class="chapter-item expanded "><a href="chapter_5.html"><strong aria-hidden="true">5.</strong> Multi-Level Feedback Queue</a></li><li class="chapter-item expanded "><a href="chapter_6.html"><strong aria-hidden="true">6.</strong> Proportional Share</a></li><li class="chapter-item expanded "><a href="chapter_7.html"><strong aria-hidden="true">7.</strong> Address Spaces</a></li><li class="chapter-item expanded "><a href="chapter_8.html" class="active"><strong aria-hidden="true">8.</strong> Mechanism - Address Translation</a></li><li class="chapter-item expanded "><a href="chapter_9.html"><strong aria-hidden="true">9.</strong> Segmentation</a></li><li class="chapter-item expanded "><a href="chapter_10.html"><strong aria-hidden="true">10.</strong> Free-Space Management</a></li><li class="chapter-item expanded "><a href="chapter_11.html"><strong aria-hidden="true">11.</strong> Paging - Introduction</a></li><li class="chapter-item expanded "><a href="chapter_12.html"><strong aria-hidden="true">12.</strong> Paging - Faster Translation</a></li><li class="chapter-item expanded "><a href="chapter_13.html"><strong aria-hidden="true">13.</strong> Paging - Smaller Tables</a></li><li class="chapter-item expanded "><a href="chapter_14.html"><strong aria-hidden="true">14.</strong> Beyond Physical Memory - Mechanism</a></li><li class="chapter-item expanded "><a href="chapter_15.html"><strong aria-hidden="true">15.</strong> Physical Memory - Policies</a></li><li class="chapter-item expanded "><a href="chapter_17.html"><strong aria-hidden="true">16.</strong> Concurrency - An Introduction</a></li><li class="chapter-item expanded "><a href="chapter_18.html"><strong aria-hidden="true">17.</strong> Thread API</a></li><li class="chapter-item expanded "><a href="chapter_19.html"><strong aria-hidden="true">18.</strong> Locks</a></li><li class="chapter-item expanded "><a href="chapter_20.html"><strong aria-hidden="true">19.</strong> Lock-Based Concurrent Data Structures</a></li><li class="chapter-item expanded "><a href="chapter_21.html"><strong aria-hidden="true">20.</strong> Condition Variables</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Operating Systems: Book Summary</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="8-mechanism---address-translation"><a class="header" href="#8-mechanism---address-translation">8. Mechanism - Address Translation</a></h1>
<h2 id="introduction"><a class="header" href="#introduction">Introduction</a></h2>
<p><strong>Definition:</strong> With address translation, the hardware transforms each memory access(e.g, an instruction fetch, load, or store) changing the virtual address provided by the instruction to a physical address where the desired information is actually located. </p>
<ul>
<li>With every memory reference, a translation is done. </li>
<li>Hardware cannot do this by it's own, OS must manage memory (gets involved so the correct translations take place)</li>
<li>The main goal it's to create an illusion that the running program has it's own private memory, where only his code and data reside. </li>
</ul>
<h3 id="crux"><a class="header" href="#crux">Crux</a></h3>
<p>How to efficiently and flexibly virtualize memory? </p>
<h2 id="example"><a class="header" href="#example">Example:</a></h2>
<p>Suppose we have the following C program: </p>
<pre><code class="language-C">// simple.c
int main(void) {
	int x = 3000;
	x = x + 3;
	return 0;
}
</code></pre>
<p>To compile this code to assembly you can use <code>gcc</code>, on Linux: </p>
<pre><code class="language-bash">$ gcc -O0 -S -c simple.c -o simple.S
</code></pre>
<p><em>Note: the <code>-O0</code> part is highly important as it disables compiler optimization, without this, the compiler might realize you aren't doing nothing between <code>int x = 3000;</code> and <code>x = x + 3;</code> and might optimize that into <code>int x = 3003;</code></em></p>
<p>This will generate a <code>simple.S</code> assembly file which you can inspect. On <em>x86-64</em> look for two consecutive instructions <code>movl</code> and <code>addl</code>
The compiler turns this code into assembly, which <strong>might</strong> look like this (in <em>x86</em> assembly): </p>
<pre><code class="language-assembly">128: movl 0x0(%ebx), %eax
132: addl $0x03, %eax
135: movl %eax, 0x0(%ebx)
</code></pre>
<p>In this code snippet: </p>
<ul>
<li>Address of <code>x</code> has been placed in the register <code>ebx</code> </li>
<li>Value at <code>ebx</code> it's loaded to the general purpose register <code>eax</code> using <code>movl</code> instruction.</li>
<li><code>addl</code> adds 3 to <code>eax</code> </li>
<li>The final instruction stores the value in <code>eax</code> back into memory at that same location. </li>
</ul>
<p>The address space of this process might look like this: </p>
<center><img src="./images/ProcAS.png"></center>
<p>Here we can see: </p>
<ul>
<li>The 3 instruction code sequence is located at address <code>128</code></li>
<li>The value of the variable <code>x</code> is at address 15KB (on the stack)</li>
</ul>
<p>When the process run: </p>
<ul>
<li>Fetch instruction at address 128</li>
<li>Execute this instruction (load from address 15KB) </li>
<li>Fetch instruction at 132</li>
<li>Execute this instruction</li>
<li>Fetch instruction at 135</li>
<li>Execute this instruction (store to address 15KB)</li>
</ul>
<h3 id="notes"><a class="header" href="#notes">Notes</a></h3>
<ul>
<li>From this example program perspective, his address starts at 0 and ends at 16KB </li>
<li>However the OS might allocated the memory of this program somewhere else in memory (i.e between address 32KB and 48KB )</li>
<li>The size it's the same however the location differs. </li>
</ul>
<h2 id="dynamic-hardware-based-relocation"><a class="header" href="#dynamic-hardware-based-relocation">Dynamic (Hardware-based) Relocation</a></h2>
<ul>
<li>It's a technique to do hardware-based address translation. </li>
<li>We'll need two hardware registers within each CPU:
<ul>
<li>One is called <em>base</em> register</li>
<li>The other the <em>bounds</em> (a.k.a <em>limit</em> register)</li>
</ul>
</li>
<li>This registers allows us to place the address space of a program anywhere in physical memory </li>
<li>Also called <em>base-and-bounds</em></li>
</ul>
<h3 id="base"><a class="header" href="#base">Base</a></h3>
<p>Each program is written and compiled as if it is loaded at address zero, however when the program starts running, the OS decides where in physical memory the program is loaded and it set the registers to those values.</p>
<p>When a memory reference happens in the running program, the process translate the memory in the following manner: </p>
<pre><code>physical address = virtual address + base
</code></pre>
<p>For example, in the previous example, when this instruction has to be fetched: </p>
<pre><code>128: movl 0x0(%ebx), %eax
</code></pre>
<p>The cpu first adds the value of the base register (in this case 32KB) to the 128 to get 32896. This is the physical  address of the instruction and now the CPU can fetch and execute this instruction.</p>
<p>Same happens when accessing the value <code>3000</code> at address 15KB, the base register value is added to get physical address 47KB.</p>
<h3 id="bound"><a class="header" href="#bound">Bound</a></h3>
<p>The point of this register is to make sure that all addresses generated by the process are legan and within the <em>bounds</em> of the process. </p>
<ul>
<li>When a memory reference happens, the process will first check that the memory reference is <em>within bounds</em> (is legal), the bound limit helps with protection. </li>
<li>It can contain either the size of the address space or the physical address of the end of the address space. </li>
</ul>
<h3 id="example-translations"><a class="header" href="#example-translations">Example translations</a></h3>
<p>We have a process with an address space of size 4KB that has been loaded at physical address 16KB:</p>
<div class="table-wrapper"><table><thead><tr><th>Virtual address</th><th>Physical address</th></tr></thead><tbody>
<tr><td>0</td><td>16KB</td></tr>
<tr><td>1KB</td><td>17KB</td></tr>
<tr><td>3000</td><td>19384</td></tr>
<tr><td>4400</td><td><em>Fault (out of bounds</em></td></tr>
</tbody></table>
</div>
<h2 id="operating-system-issues"><a class="header" href="#operating-system-issues">Operating system issues</a></h2>
<p>There are a few critical junctures where the OS must get involved to implement our based-and-bounds version of virtual memory: </p>
<ol>
<li>The OS when a process is created must find space for its address space in memory. </li>
<li>When a process is terminated, it must reclaim all of its memory to be used by other process. Cleaning all data structures associated with that process</li>
<li>When a context switch occur, the OS must save and restore the base-and-bound pair when it switches between processes. </li>
<li>It must provide exception handlers. For example if a process tries to access memory outside of its bounds, the CPU will raise an exception; the OS must be prepared to take action when such an exception arises. </li>
</ol>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="chapter_7.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="chapter_9.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="chapter_7.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="chapter_9.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <!-- Livereload script (if served using the cli tool) -->
        <script>
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsAddress = wsProtocol + "//" + location.host + "/" + "__livereload";
            const socket = new WebSocket(wsAddress);
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
